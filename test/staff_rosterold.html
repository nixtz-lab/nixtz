<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nixtz | Staff Roster & Timetable</title>

<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
    theme: {
        extend: {
            colors: {
                'nixtz-primary': '#4F46E5', // Indigo/Blue
                'nixtz-secondary': '#10B981', // Emerald/Green
                'nixtz-bg': '#0F172A', // Very dark background (Slate 900)
                'nixtz-card': '#1E293B', // Dark card background (Slate 800)
            },
            fontFamily: {
                sans: ['Inter', 'sans-serif'],
            },
        }
    }
}
</script>
<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/lucide@latest"></script>
<!-- FIX: Load script.js in the head to ensure global variables like API_BASE_URL are defined before inline scripts use them -->
<script src="script.js"></script> 
<style>
    /* Custom styles for the table cells to manage input appearance */
    .roster-cell {
        padding: 4px;
        min-width: 100px;
        position: relative;
        cursor: pointer;
    }
    .roster-cell input, .roster-cell select {
        background-color: transparent;
        border: none;
        width: 100%;
        text-align: center;
        font-size: 14px;
        color: white;
        padding: 0;
        margin: 0;
    }
    .shift-summary {
        font-size: 12px;
        font-weight: 600;
        text-align: center;
        color: #94A3B8; /* Slate 400 */
    }
    .shift-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 50;
        width: 160px;
        background-color: #334155; /* Slate 700 */
        border: 1px solid #475569;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        padding: 8px;
    }
    .dropdown-button {
        display: block;
        width: 100%;
        padding: 6px 10px;
        text-align: left;
        color: white;
        font-size: 13px;
        border-radius: 4px;
        transition: background-color 0.1s;
    }
    .dropdown-button:hover {
        background-color: #4F46E5; /* nixtz-primary */
    }
</style>
</head>
<body class="bg-nixtz-bg font-sans antialiased">
    <!-- Message Box & Header kept as is (ensure script.js is loaded) -->
    <div id="message-box" class="fixed top-4 right-4 p-4 rounded-lg shadow-2xl z-[9999] hidden text-white bg-nixtz-primary transition duration-300 opacity-0">
        <p id="message-text" class="font-semibold"></p>
    </div>
    
    <!-- MODIFIED: Include the Nixtz header content here for standalone pages -->
    <header class="bg-nixtz-bg shadow-2xl sticky top-0 z-50 border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-3 flex items-center justify-between">

            <div class="flex items-center space-x-4">
                <a href="index.html">
                    <img
                        src="images/nixtz_logo.png"
                        alt="Nixtz Business Software Logo"
                        class="h-14 sm:h-16 w-auto rounded-xl"
                        title="Nixtz Business Software"
                    >
                </a>
            </div>

            <div class="flex items-center space-x-4 sm:space-x-6">
                
                <a href="javascript:void(0)" onclick="checkAccessAndRedirect('business_dashboard.html')" 
                   class="text-nixtz-primary hover:text-nixtz-secondary transition duration-300 stacked-nav-link focus:outline-none font-medium ml-4 sm:ml-6" 
                   title="Quick Dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="text-[10px] leading-tight md:text-[10px] md:leading-tight">Dashboard</span>
                </a>
                
                <nav id="desktop-nav-links" class="hidden md:flex space-x-3 text-sm">
                    <!-- Nav links here (Copy from index.html if needed, but primary focus is access) -->
                    <a href="javascript:void(0)" onclick="checkAccessAndRedirect('staff_roster.html')" class="text-gray-400 hover:text-nixtz-primary transition duration-300">Staff Roster</a>
                    <a href="javascript:void(0)" onclick="checkAccessAndRedirect('asset_tracker.html')" class="text-gray-400 hover:text-nixtz-primary transition duration-300">Assets</a>
                    <a href="javascript:void(0)" onclick="checkAccessAndRedirect('yearly_budget_planning.html')" class="text-gray-400 hover:text-nixtz-primary transition duration-300">Budget Planning</a>
                </nav>
                
                <div id="auth-buttons-container" class="flex items-center space-x-4 sm:space-x-6">
                    <a href="auth.html?mode=login" id="login-button" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-1.5 px-4 md:px-5 rounded-full shadow-lg transition duration-300 transform hover:scale-105 border border-gray-700 text-sm md:text-sm">
                        Login
                    </a>
                    <a href="auth.html?mode=join" id="join-button" class="bg-nixtz-primary hover:bg-[#3f3bbf] text-white font-bold py-1.5 px-4 md:px-5 rounded-full shadow-lg transition duration-300 transform hover:scale-105 text-sm md:text-sm">
                        Join
                    </a>
                </div>
                
                <div id="user-menu-container" class="group relative flex items-center space-x-2 hidden"> 
                    <button id="nav-user-button" class="w-10 h-10 bg-nixtz-primary rounded-full flex items-center justify-center font-bold text-white hover:scale-105 transition duration-200" title="User Settings">
                        <i data-lucide="user" class="w-6 h-6"></i>
                    </button>
                    <span id="username-display" class="font-semibold text-white hidden sm:inline">User</span>
                    <!-- Simplified dropdown for brevity -->
                    <div id="user-dropdown" class="absolute right-0 top-full mt-3 w-64 bg-gray-800 rounded-xl shadow-3xl-dark border border-gray-700/50 p-4 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 origin-top-right scale-95 group-hover:scale-100 z-50">
                        <button id="logout-button" class="w-full text-center text-sm text-red-400 hover:text-red-500 transition duration-200 font-medium py-2 px-3 rounded-lg hover:bg-gray-700">
                            <i data-lucide="log-out" class="w-4 h-4 mr-2 inline"></i> Logout
                        </button>
                    </div>
                </div>
                
                <button id="menu-toggle" class="md:hidden p-2 rounded-lg text-gray-400 hover:text-nixtz-primary transition duration-200" aria-label="Toggle Menu">
                    <svg id="icon-open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    <svg id="icon-close" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>

            </div>
        </div>
    </header>

<main class="py-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-extrabold text-white mb-6 border-b border-gray-700 pb-3">
            7-Eleven Weekly Staff Roster (Nixtz)
        </h1>
        
        <!-- Roster Controls -->
        <div class="bg-nixtz-card p-4 rounded-xl shadow-lg mb-6 border border-gray-700/50 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-6">
            
            <div class="flex items-center space-x-3 w-full md:w-auto">
                <label for="week-start-date" class="text-gray-300 font-medium whitespace-nowrap">Week Start (Mon):</label>
                <input type="date" id="week-start-date" 
                       class="p-2 rounded-lg bg-gray-800 border border-gray-600 text-white focus:border-nixtz-secondary transition duration-200"
                       onchange="loadRoster(this.value)">
            </div>

            <div class="flex items-center space-x-4 w-full md:w-auto">
                <button onclick="addStaffRow()" class="bg-nixtz-secondary hover:bg-[#0da070] text-white font-bold py-2 px-4 rounded-full shadow-md transition duration-200 flex items-center">
                    <i data-lucide="plus" class="w-5 h-5 mr-1"></i> Add Staff
                </button>
                <button onclick="saveRoster()" id="save-roster-btn" class="bg-nixtz-primary hover:bg-[#3f3bbf] text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-200 flex items-center disabled:opacity-50">
                    <i data-lucide="save" class="w-5 h-5 mr-1"></i> Save Roster
                </button>
            </div>
        </div>

        <!-- Roster Table Container (Responsive) -->
        <div class="overflow-x-auto bg-nixtz-card rounded-xl shadow-2xl border border-gray-700/50">
            <table id="roster-table" class="min-w-full divide-y divide-gray-700 text-gray-300">
                <thead>
                    <tr class="bg-gray-800 text-sm uppercase tracking-wider">
                        <th class="p-3 text-left w-48">Staff Name / ID</th>
                        <!-- Dynamic Day Headers -->
                        <th class="p-3 text-center">Mon</th>
                        <th class="p-3 text-center">Tue</th>
                        <th class="p-3 text-center">Wed</th>
                        <th class="p-3 text-center">Thu</th>
                        <th class="p-3 text-center">Fri</th>
                        <th class="p-3 text-center">Sat</th>
                        <th class="p-3 text-center">Sun</th>
                    </tr>
                </thead>
                <tbody id="roster-body" class="divide-y divide-gray-800">
                    <!-- Staff rows will be injected here -->
                </tbody>
                <!-- Shift Summary Footer -->
                <tfoot class="bg-gray-900 border-t-2 border-nixtz-secondary">
                    <tr class="text-xs font-bold uppercase text-white">
                        <td class="p-3">Required Staff (M:6, A:5)</td>
                        <td id="shift-summary-mon" class="p-3"></td>
                        <td id="shift-summary-tue" class="p-3"></td>
                        <td id="shift-summary-wed" class="p-3"></td>
                        <td id="shift-summary-thu" class="p-3"></td>
                        <td id="shift-summary-fri" class="p-3"></td>
                        <td id="shift-summary-sat" class="p-3"></td>
                        <td id="shift-summary-sun" class="p-3"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Job Role & Shift Time Definitions -->
        <div class="mt-8 p-4 bg-nixtz-card rounded-xl border border-gray-700/50 text-gray-400">
            <h3 class="text-lg font-bold text-nixtz-secondary mb-3">Shift & Job Definitions</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                    <span class="font-semibold text-white">Morning (1):</span> 07:00 - 16:00
                    <div class="text-xs text-gray-500">Required: 6 Staff (C1-C5)</div>
                </div>
                <div>
                    <span class="font-semibold text-white">Afternoon (2):</span> 13:30 - 22:30
                    <div class="text-xs text-gray-500">Required: 5 Staff (C1-C5)</div>
                </div>
                <div>
                    <span class="font-semibold text-white">Night (3):</span> 22:00 - 07:00
                    <div class="text-xs text-gray-500">Required: *Determined by Night Staff* (C1, C2 Only)</div>
                </div>
            </div>
            <p class="mt-3 text-xs italic">Job Roles: C1, C2 (Night only), C3, C4, C5 (All shifts except Night).</p>
        </div>

    </div>
</main>

<script>
// --- ROSTER DATA STRUCTURES & CONFIG ---
// MODIFIED: Use the globally available API_BASE_URL
const API_URL = `${window.API_BASE_URL}/api/staff/roster`;
const SHIFTS = { 
    1: { name: 'Morning', time: '07:00-16:00', required: 6, roles: ['C1', 'C2', 'C3', 'C4', 'C5'] },
    2: { name: 'Afternoon', time: '13:30-22:30', required: 5, roles: ['C1', 'C2', 'C3', 'C4', 'C5'] },
    3: { name: 'Night', time: '22:00-07:00', required: 'N/A', roles: ['C1', 'C2'] }
};
const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

let currentRosterData = []; // Array of { employeeName, employeeId, weeklySchedule: [...] }
let currentWeekStartDate = null;

// --- UTILITIES ---
// NOTE: getAuthStatus and showMessage are global functions defined in script.js
function getRosterForSave() {
    const rows = document.querySelectorAll('#roster-body tr');
    const rosterData = [];

    rows.forEach(row => {
        const nameInput = row.querySelector('.staff-name-input');
        const idInput = row.querySelector('.staff-id-input');
        // FIX: Ensure both name and ID input elements are present before checking values
        if (!nameInput || !idInput || !nameInput.value.trim()) return;

        const weeklySchedule = [];
        DAYS.forEach((day, dayIndex) => {
            const shiftCell = row.querySelector(`[data-day="${day}"]`);
            if (shiftCell) {
                // Get the text content from the cell (e.g., '1 C3' or '2 C1')
                const cellText = shiftCell.textContent.trim();
                
                // --- Complex Logic to Parse Cell Content ---
                const shifts = [];
                // Check for 'Leave' or the Thai equivalent '휴가' (which was likely used as a placeholder)
                if (cellText && cellText !== 'Leave' && cellText !== '휴ഗാ') { 
                    const parts = cellText.split(' '); // e.g., ['1', 'C3']
                    const shiftId = parseInt(parts[0]);
                    const jobRole = parts[1]?.split('<')[0]; // Ensure we strip off any nested HTML text
                    
                    if (!isNaN(shiftId) && SHIFTS[shiftId] && jobRole) {
                        shifts.push({
                            shiftId: shiftId,
                            jobRole: jobRole,
                            timeRange: SHIFTS[shiftId].time
                        });
                    }
                } else if (cellText === 'Leave' || cellText === '휴가') {
                    // Save as 'Leave' entry
                    shifts.push({ shiftId: null, jobRole: 'Leave', timeRange: 'Full Day' });
                }

                weeklySchedule.push({
                    dayOfWeek: day,
                    shifts: shifts
                });
            }
        });

        rosterData.push({
            employeeName: nameInput.value.trim(),
            employeeId: idInput.value.trim() || 'NEW-' + Math.random().toString(36).substring(7),
            weeklySchedule: weeklySchedule
        });
    });

    return rosterData;
}

function updateShiftSummaries() {
    const counts = {};
    const daysMap = {};
    
    // Initialize counts for each day and shift
    DAYS.forEach(day => {
        daysMap[day] = { 1: { actual: 0, required: SHIFTS[1].required }, 2: { actual: 0, required: SHIFTS[2].required }, 3: { actual: 0, required: 'N/A' } };
    });

    // 1. Iterate over all cells to count staff
    DAYS.forEach(day => {
        document.querySelectorAll(`#roster-body [data-day="${day}"]`).forEach(cell => {
            // Use cell.textContent to get text, then strip potential time HTML span
            const cellText = cell.textContent.trim().split('<')[0]; 
            if (!cellText || cellText === 'Leave' || cellText === '휴가') return;

            const shiftId = parseInt(cellText.split(' ')[0]);
            if (shiftId && daysMap[day][shiftId]) {
                daysMap[day][shiftId].actual++;
            }
        });
    });

    // 2. Update the footer cells
    DAYS.forEach(day => {
        const summaryCell = document.getElementById(`shift-summary-${day.toLowerCase()}`);
        if (!summaryCell) return;
        
        // Build the content for the cell
        let content = '';
        for (const shiftId in daysMap[day]) {
            const data = daysMap[day][shiftId];
            const required = data.required === 'N/A' ? '' : data.required;
            const statusClass = (data.required !== 'N/A' && data.actual < data.required) ? 'text-red-400' : 'text-nixtz-secondary';

            if(data.actual > 0 || required !== '') { // Only show shifts that are relevant or have staff
                content += `<div class="shift-summary">
                                <span class="text-gray-400 font-normal mr-1">${shiftId} (${required}):</span>
                                <span class="${statusClass}">${data.actual}</span>
                            </div>`;
            }
        }
        summaryCell.innerHTML = content;
    });
}

// --- DOM RENDERING ---
function createShiftDropdown(cell) {
    // Check if a dropdown already exists
    if (cell.querySelector('.shift-dropdown')) return;
    
    // Attempt to parse existing data to pre-select dropdown (for editing)
    const existingText = cell.textContent.trim().split('<')[0];
    const initialParts = existingText.split(' ');
    const initialShiftId = parseInt(initialParts[0]) || null;
    const initialJobRole = initialParts[1] || null;

    const day = cell.dataset.day;
    const shiftDropdown = document.createElement('div');
    shiftDropdown.className = 'shift-dropdown absolute hidden';
    shiftDropdown.onclick = (e) => e.stopPropagation(); // Prevent modal from closing on click inside

    // Leave Option
    shiftDropdown.innerHTML += `<button class="dropdown-button bg-red-600 hover:bg-red-500" onclick="setShiftSelection(event, '${day}', null, 'Leave')">LEAVE (휴가)</button>`;

    // Loop through shifts (1, 2, 3)
    [1, 2, 3].forEach(shiftId => {
        const shiftConfig = SHIFTS[shiftId];
        if (!shiftConfig) return;

        // Add a header for the shift type
        shiftDropdown.innerHTML += `<div class="text-xs text-gray-400 mt-2 border-t border-gray-600 pt-1">${shiftConfig.name} (${shiftConfig.time})</div>`;

        // Loop through job roles for the shift
        shiftConfig.roles.forEach(role => {
            const isSelected = (initialShiftId === shiftId && initialJobRole === role);
            
            shiftDropdown.innerHTML += `
                <button 
                    class="dropdown-button ${isSelected ? 'bg-nixtz-secondary' : ''}" 
                    onclick="setShiftSelection(event, '${day}', ${shiftId}, '${role}')"
                >
                    ${shiftId} ${role}
                </button>
            `;
        });
    });

    cell.appendChild(shiftDropdown);
    // Position the dropdown to be right-aligned if it's on the right side of the screen
    const rect = cell.getBoundingClientRect();
    if (rect.right > window.innerWidth - 200) {
        shiftDropdown.style.right = '0';
        shiftDropdown.style.left = 'auto';
    } else {
        shiftDropdown.style.left = '0';
        shiftDropdown.style.right = 'auto';
    }
    
    // Show the dropdown
    shiftDropdown.classList.remove('hidden');
}

// --- EVENT HANDLERS ---

function setShiftSelection(event, day, shiftId, jobRole) {
    const button = event.target;
    const cell = button.closest('.roster-cell');
    
    // 1. Update the cell content
    if (jobRole === 'Leave') {
        cell.innerHTML = 'Leave'; // Display simplified text
        cell.classList.remove('bg-gray-700', 'bg-nixtz-card');
        cell.classList.add('bg-red-800');
    } else {
        const shiftConfig = SHIFTS[shiftId];
        cell.innerHTML = `${shiftId} ${jobRole}<span class="text-xs text-gray-500 block leading-none">${shiftConfig.time}</span>`;
        cell.classList.remove('bg-red-800', 'bg-nixtz-card');
        cell.classList.add('bg-gray-700');
    }
    
    // 2. Hide and remove the dropdown
    cell.querySelector('.shift-dropdown')?.remove();
    
    // 3. Update the required staff counts
    updateShiftSummaries();
}

// Global function to hide any open dropdown when clicking elsewhere
function hideAllDropdowns(event) {
    // Check if the click was outside any roster cell or inside an open dropdown
    const isInsideDropdown = event.target.closest('.shift-dropdown');
    const isCell = event.target.closest('.roster-cell');
    
    // Close only if the click is outside the dropdown AND outside the cell that opened it
    if (!isInsideDropdown && !isCell) {
        document.querySelectorAll('.shift-dropdown').forEach(d => d.remove());
    } else if (isCell && !isInsideDropdown) {
        // If clicking on a different cell, close all others first before opening the new one
        document.querySelectorAll('.shift-dropdown').forEach(d => {
            if (d.closest('.roster-cell') !== isCell) {
                d.remove();
            }
        });
    }
}
document.addEventListener('click', hideAllDropdowns);


function addStaffRow(initialData = {}) {
    const rosterBody = document.getElementById('roster-body');
    const newRow = document.createElement('tr');
    newRow.className = 'hover:bg-gray-800 transition duration-150 border-b border-gray-700';

    const staffName = initialData.employeeName || '';
    const staffId = initialData.employeeId || '';

    // Staff Name Cell (Non-Editable fields)
    let rowHTML = `
        <td class="p-2 bg-gray-900 sticky left-0 z-10 border-r border-gray-700">
            <input type="text" value="${staffName}" placeholder="Staff Name" class="staff-name-input bg-transparent font-semibold w-full" data-key="name">
            <input type="text" value="${staffId}" placeholder="ID" class="staff-id-input bg-transparent text-xs text-gray-500 w-full mt-1" data-key="id">
        </td>
    `;

    // Daily Shift Cells
    DAYS.forEach(day => {
        // Find the specific schedule for this day
        const daySchedule = initialData.weeklySchedule?.find(s => s.dayOfWeek === day);
        let cellContent = '';
        let cellClasses = 'bg-nixtz-card';
        
        if (daySchedule && daySchedule.shifts.length > 0) {
            const shift = daySchedule.shifts[0]; // Assuming one main shift per day for simplicity
            const shiftConfig = shift.shiftId ? SHIFTS[shift.shiftId] : null;

            if (shift.jobRole === 'Leave') {
                cellContent = 'Leave';
                cellClasses = 'bg-red-800 font-bold';
            } else if (shift.shiftId && shift.jobRole && shiftConfig) {
                cellContent = `${shift.shiftId} ${shift.jobRole}<span class="text-xs text-gray-500 block leading-none">${shiftConfig.time}</span>`;
                cellClasses = 'bg-gray-700';
            }
        }
        
        rowHTML += `
            <td class="roster-cell p-2 border-r border-gray-700 ${cellClasses}" 
                data-day="${day}" 
                onclick="createShiftDropdown(this)">
                ${cellContent}
            </td>
        `;
    });
    
    // Add a delete button
    rowHTML += `<td class="p-2 text-center bg-gray-900 border-l border-gray-700">
                    <button onclick="deleteStaffRow(this)" class="text-red-500 hover:text-red-400 transition duration-200" title="Delete Row">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </td>`;

    newRow.innerHTML = rowHTML;
    rosterBody.appendChild(newRow);
    
    // Re-render Lucide icons for the new row
    lucide.createIcons();
    updateShiftSummaries();
}
window.addStaffRow = addStaffRow;

function deleteStaffRow(button) {
    button.closest('tr').remove();
    updateShiftSummaries(); // Recalculate staff count after deletion
}
window.deleteStaffRow = deleteStaffRow;


// --- API CALLS ---
async function loadRoster(startDateString) {
    if (!startDateString) return;
    // Use window.getAuthStatus for global access check
    if (!window.getAuthStatus || !getAuthStatus()) return showMessage("Please log in to load the roster.", true);

    // Format the date to ISO start-of-day for the backend query
    const isoDate = new Date(startDateString).toISOString().split('T')[0];
    
    showMessage(`Loading roster for week starting ${isoDate}...`, false);
    
    try {
        const response = await fetch(`${API_URL}/${isoDate}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('tmt_auth_token')}`,
                'Content-Type': 'application/json',
            },
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to fetch roster data.');
        }

        const result = await response.json();
        
        // Clear old roster and set new data
        document.getElementById('roster-body').innerHTML = '';
        currentRosterData = result.data;
        currentWeekStartDate = startDateString;

        if (currentRosterData.length === 0) {
            showMessage('No saved roster found for this week. Start adding staff!', true);
            // Add a few blank rows to start
            for(let i = 0; i < 5; i++) addStaffRow({});
        } else {
            currentRosterData.forEach(data => addStaffRow(data));
            showMessage(`Roster loaded successfully for ${currentRosterData.length} employees.`, false);
        }

    } catch (error) {
        console.error("Load Roster Error:", error);
        showMessage(`Error loading roster: ${error.message}`, true);
    }
}
window.loadRoster = loadRoster;


async function saveRoster() {
    if (!currentWeekStartDate) return showMessage("Please select a Week Start Date before saving.", true);
    // Use window.getAuthStatus for global access check
    if (!window.getAuthStatus || !getAuthStatus()) return showMessage("Please log in to save the roster.", true);
    
    const rosterData = getRosterForSave();
    if (rosterData.length === 0) return showMessage("Add at least one staff member before saving.", true);

    const saveButton = document.getElementById('save-roster-btn');
    saveButton.disabled = true;
    showMessage("Saving roster...", false);

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('tmt_auth_token')}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                weekStartDate: currentWeekStartDate, 
                rosterData: rosterData 
            }),
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to save roster.');
        }

        const result = await response.json();
        showMessage(`Roster saved successfully! ${result.upsertedCount} new entries, ${result.modifiedCount} updated.`, false);

    } catch (error) {
        console.error("Save Roster Error:", error);
        showMessage(`Error saving roster: ${error.message}`, true);
    } finally {
        saveButton.disabled = false;
    }
}
window.saveRoster = saveRoster;


// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // Check access before doing anything
    if (!window.getAuthStatus || !getAuthStatus()) {
        showMessage("You need to log in to access the Roster Management.", true);
        // Optionally redirect to login here
        return; 
    }

    // Set default date to the most recent Monday
    const today = new Date();
    const day = today.getDay(); // 0 = Sunday, 1 = Monday
    const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
    const monday = new Date(today.setDate(diff));

    // Format YYYY-MM-DD
    const isoString = monday.toISOString().split('T')[0];
    
    document.getElementById('week-start-date').value = isoString;
    loadRoster(isoString);

    // Initial table setup (empty)
    updateShiftSummaries();

    // Re-render Lucide icons
    lucide.createIcons();
});
</script>
</body>
</html>